<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:slash="http://purl.org/rss/1.0/modules/slash/" xmlns:sy="http://purl.org/rss/1.0/modules/syndication/" xmlns:wfw="http://wellformedweb.org/CommentAPI/">
 <channel>
  <title>
   Software Development – Et-Setera
  </title>
  <atom:link href="https://www.setera.org/category/software-development/feed/" rel="self" type="application/rss+xml">
  </atom:link>
  <link/>
  https://www.setera.org
  <description>
   Ramblings of a geek
  </description>
  <lastbuilddate>
   Fri, 15 Nov 2013 00:56:48 +0000
  </lastbuilddate>
  <language>
   en-US
  </language>
  <sy:updateperiod>
   hourly
  </sy:updateperiod>
  <sy:updatefrequency>
   1
  </sy:updatefrequency>
  <generator>
   https://wordpress.org/?v=4.5.24
  </generator>
  <item>
   <title>
    Android Native Libraries In Root Context
   </title>
   <link/>
   https://www.setera.org/2013/11/14/android-native-libraries/
   <pubdate>
    Fri, 15 Nov 2013 00:56:48 +0000
   </pubdate>
   <dc:creator>
    <![CDATA[Craig Setera]]>
   </dc:creator>
   <category>
    <![CDATA[Android]]>
   </category>
   <category>
    <![CDATA[Mobile]]>
   </category>
   <category>
    <![CDATA[Software Development]]>
   </category>
   <guid ispermalink="false">
    https://www.setera.org/?p=733
   </guid>
   <description>
    <![CDATA[As usual, I am jumping around from one side project to the next, always looking for the next shiny object. A repeat of a Broadcom networking bug on my new HTC One, lead me to want to be able to dig into the underlying network packets. There are a number of pieces to this project [&#8230;]]]>
   </description>
   <content:encoded>
    <![CDATA[<p>As usual, I am jumping around from one side project to the next, always looking for the next shiny object.  A repeat of a <a href="http://forum.xda-developers.com/showthread.php?t=1408433&#038;page=2">Broadcom networking bug</a> on my new HTC One, lead me to want to be able to dig into the underlying network packets.  There are a number of pieces to this project that are completely new to me, including building native code libraries (libpcap) and executing code as a root user on-device to allow libpcap to access the low-level networking stack.<br />
<span id="more-733"></span></p>
<h2>Building libpcap</h2>
<p>After a lot of false starts, it turned out to be fairly simple to build the native libpcap library.  In my original attempts, I was working to build the entire <a href="http://www.cyanogenmod.org/">Cyanogenmod ROM</a> for my device so I could harvest the libpcap so file.  While this might have eventually worked out, it was a very difficult path.  In the end, the “proper” way to do this was to use the Android NDK to build the Android libpcap native code as part of my project.</p>
<h2>Running As Root</h2>
<p>Libpcap requires root access in order to access the low-level networking stack.  On the surface, this seems pretty simple to do using the support provided by the <a href="https://code.google.com/p/roottools/">RootTools project</a>.  However, it turns out that the combination of root applications and access to native libraries is a bit tricky.</p>
<p>When using RootTools, launching a root application actually involves multiple processes:</p>
<div id="attachment_736" style="width: 310px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2013/11/processes_diag.png"><img src="https://www.setera.org/wp-content/uploads/2013/11/processes_diag-300x95.png" alt="Processes Diagram" width="300" height="95" class="size-medium wp-image-736" srcset="https://www.setera.org/wp-content/uploads/2013/11/processes_diag-300x95.png 300w, https://www.setera.org/wp-content/uploads/2013/11/processes_diag.png 620w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Processes Diagram</p></div>
<p>The initial process is the main application with an Android Activity.  This activity interacts with the RootTools support which checks for root ability and, if found, launches a new shell process with root authority.  That root shell mediates between the original Activity and root applications launched on behalf of the original activity.  For short-running root applications, it is possible to communicate using the STDIN and STDOUT pipes.  However, for a long-running service, it makes more sense to use some other communications channel to communicate between the Android activity and the root application.  One possibility would be a Unix domain socket provided by the <code>android.net.LocalSocket</code> class.</p>
<h2>Native Libraries And Root</h2>
<p>While RootTools provides the infrastructure shown above, the problem I ran into was that when launching the root application (process 3), it would not be able to locate the native libraries that the JNI class was dependent on.  The RootTools <code>JavaCommandCapture</code> class launches the Java class using a command similar to:</p>
<blockquote><p>dalvikvm -cp /path/to/anbuild.dex com.android.internal.util.WithFramework com.stericson.RootTools.containers.RootClass my.package.RootCodeClass
</p></blockquote>
<p>This long incantation starts up a new Java Application using the Dalvik VM.  The WithFramework class <em>&#8220;Binds native framework methods and then invokes a main class with the remaining arguments&#8221;</em> and then calls the <code>RootClass</code> class.  Finally, the <code>RootClass</code> class invokes the <code>RootCodeClass</code> constructor passing along the remaining command-line arguments.  RootTools expects the root functionality to occur as part of the construction of <code>RootCodeClass</code>, however if <code>RootCodeClass</code> has a JNI dependency on a native library the functionality will fail with an <code>UnsatisfiedLinkError</code> exception.</p>
<h3>dalvik.system.BaseDexClassLoader</h3>
<p>Normally, Java may be started with the <code>“java.library.path”</code> System property to set the location of the native libraries, however that doesn&#8217;t appear to work correctly in Android.  In addition, the <code>LD_LIBRARY_PATH</code> from Linux won&#8217;t work either.  It turns out that Android actually pulls the native library path from the Classloader that is used to load the class referring to the native static library.</p>
<p>The <code>dalvik.system.BaseDexClassLoader</code> class acts as both a Java class loader mechanism and a holder of the native library path.  The initial classloader started by the Dalvik VM does not contain any references to the static library path leading to the linkage failures.  I was able to solve this, by adding yet another layer of indirection:</p>
<div id="attachment_735" style="width: 310px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2013/11/classloader_diag.png"><img src="https://www.setera.org/wp-content/uploads/2013/11/classloader_diag-300x136.png" alt="Classloader Diagram" width="300" height="136" class="size-medium wp-image-735" srcset="https://www.setera.org/wp-content/uploads/2013/11/classloader_diag-300x136.png 300w, https://www.setera.org/wp-content/uploads/2013/11/classloader_diag.png 510w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Classloader Diagram</p></div>
<p>In this model, the initial <code>RootCodeClass</code> constructor creates a new <code>BaseDexClassLoader</code> instance referencing the native libraries path.</p>
<pre name="code" class="java">
JavaRootClassloader targetLoader = new JavaRootClassloader(
				nativeClasspath, 
				null, 
				nativeLibPath, 
				getClass().getClassLoader());
</pre>
<p>In this case, the native classpath and native libraries have been passed in as command-line arguments from the originating Activity.  The targetLoader must be used to load the target class in order for the target JNI classes to use the provided native libraries.  It is important that these classes be kept in separate classloaders to avoid errors in the Dalvik VM about redefinition of classes.</p>
<pre name="code" class="java">
Class&lt;?&gt;targetClass = targetLoader.loadTargetClass(targetClassName); 
</pre>
<p>The loadTargetClass method is a special Classloader method that uses classloader-first rather than parent-first lookup to avoid using the parent classloader which does not have the native library path defined.</p>
<pre name="code" class="java">
/**
	 * Load the specified class, making sure to *not* do a parent-first load
	 * as we will end up with the wrong classloader.
	 * 
	 * @param targetClassName
	 * @return
	 * @throws ClassNotFoundException 
	 */
	public Class&lt;?&gt; loadTargetClass(String targetClassName) 
		throws ClassNotFoundException 
	{
        Class&lt;?&gt; clazz = findLoadedClass(targetClassName);

        if (clazz == null) {
        	// Look locally first for our target class
        	clazz = findClass(targetClassName);
        }

        return clazz;
	}
</pre>
<p>In the current implementation, all of the information necessary to launch the final targetted class with native library path properly set is provided by the originating Activity.  Remaining command-line arguments are captured by the “launcher” class and provided as the arguments to the main method of the target class.</p>
<h3>DEX Files</h3>
<p>The default RootTools approach for creating Java classes that can be loaded in the root context is by adding the <code>com.stericson.RootTools.containers.RootClass.Candidate</code> annotation to the root classes and then processing with the <code>com.stericson.RootTools.containers.RootClass</code> class.  The result of this process it to create an Android DEX file called <code>anbuild.dex</code>.  I struggled to get this all to play nicely and get all of the proper classes into the proper DEX files.  As mentioned, loading the same class in different classloaders can cause Dalvik VM errors that look like the following:</p>
<blockquote><p>Class ref in pre-verified class resolved to unexpected implementation</p></blockquote>
<p>In the end, I ended up with three separate DEX files:</p>
<ul>
<li>Standard application DEX file<br />
This file is automatically built and handled by the Android tools and the runtime.  This file contains the code for the main Activity and associated logic</li>
<p></p>
<li>Root Launcher DEX file<br />
This file contains just necessary classes to be loaded by RootTools and to create the special Classloader instance that can load the real root functionality while specifying the native libraries path.  This DEX file is generated as rootlauncher.dex into the res/raw folder</li>
<p></p>
<li>Root functionality DEX file<br />
This DEX file contains the Java functionality that will run in a root context that will have access to the native libraries necessary to interact with the system.  This DEX file is generated as root.dex into the res/raw folder</li>
<p>
</ul>
<h4>Building The DEX Files</h4>
<p>Because of this added complexity in creating the multiple DEX files, I had to take more control over the build process.  Taking advantage of Eclipse&#8217;s ability to call out to an Ant build.xml as part of the build process.  For instance, the build.xml file for generating the DEX files would look something like:</p>
<pre name="code" class="xml">
    &lt;target name="build_root_dexs"&gt;  	
    	&lt;property name="dx.path" value="${user.home}/software/unzipped/android-sdk-macosx-personal/build-tools/${build-tools-version}/dx" /&gt;
    	
    	&lt;!-- Build the root launcher --&gt;
    	&lt;unzip src="libs/RootTools-3.3.jar" dest="bin/classes-launcher"&gt;
    		&lt;patternset&gt;
    			&lt;include name="com/stericson/RootTools/containers/*.class"/&gt;
    		&lt;/patternset&gt;
    	&lt;/unzip&gt;

    	&lt;echo message="Building rootlauncher.dex" /&gt;
    	&lt;exec executable="${dx.path}"&gt;
    		&lt;arg value="--dex" /&gt;
    		&lt;arg value="--output=res/raw/rootlauncher.dex" /&gt;
    		&lt;arg value="--positions=lines" /&gt;
    		&lt;arg value="bin/classes-launcher" /&gt;
    	&lt;/exec&gt;
    	
    	&lt;!-- Build the code that will run within the root container --&gt;
    	&lt;echo message="Building root.dex" /&gt;
    	&lt;exec executable="${dx.path}"&gt;
    		&lt;arg value="--dex" /&gt;
    		&lt;arg value="--output=res/raw/root.dex" /&gt;
    		&lt;arg value="--positions=lines" /&gt;
    		&lt;arg value="bin/classes-root" /&gt;
    	&lt;/exec&gt;
  &lt;/target&gt;

</pre>
<p>An Ant build can be added to the build file via the Project properties:</p>
<div id="attachment_740" style="width: 310px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2013/11/eclipse_builders.png"><img src="https://www.setera.org/wp-content/uploads/2013/11/eclipse_builders-300x258.png" alt="Eclipse Builders" width="300" height="258" class="size-medium wp-image-740" srcset="https://www.setera.org/wp-content/uploads/2013/11/eclipse_builders-300x258.png 300w, https://www.setera.org/wp-content/uploads/2013/11/eclipse_builders.png 618w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Eclipse Builders</p></div>
<p>Add a new Ant Builder:</p>
<div id="attachment_739" style="width: 310px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2013/11/eclipse_builder_type.png"><img src="https://www.setera.org/wp-content/uploads/2013/11/eclipse_builder_type-300x293.png" alt="Eclipse Builder Type" width="300" height="293" class="size-medium wp-image-739" srcset="https://www.setera.org/wp-content/uploads/2013/11/eclipse_builder_type-300x293.png 300w, https://www.setera.org/wp-content/uploads/2013/11/eclipse_builder_type.png 386w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Eclipse Builder Type</p></div>
<p>Choose your Ant file:</p>
<div id="attachment_738" style="width: 310px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2013/11/eclipse_builder_order.png"><img src="https://www.setera.org/wp-content/uploads/2013/11/eclipse_builder_order-300x270.png" alt="Ant Build File" width="300" height="270" class="size-medium wp-image-738" srcset="https://www.setera.org/wp-content/uploads/2013/11/eclipse_builder_order-300x270.png 300w, https://www.setera.org/wp-content/uploads/2013/11/eclipse_builder_order.png 482w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Ant Build File</p></div>
<p>And save the resulting build launch configuration:</p>
<div id="attachment_737" style="width: 310px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2013/11/eclipse_ant_builder.png"><img src="https://www.setera.org/wp-content/uploads/2013/11/eclipse_ant_builder-300x248.png" alt="Build Configuration" width="300" height="248" class="size-medium wp-image-737" srcset="https://www.setera.org/wp-content/uploads/2013/11/eclipse_ant_builder-300x248.png 300w, https://www.setera.org/wp-content/uploads/2013/11/eclipse_ant_builder.png 699w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Build Configuration</p></div>
<h2>Caveats</h2>
<p>While this approach is working fine for Android 4.0+, there are a lot of pieces of this puzzle that are private/internal to the Android implementation.  For that reason, many of these internals have the chance of changing over time.  In particular:</p>
<ul>
<li>The <code>com.android.internal.util.WithFramework</code> is clearly marked as an internal class</li>
<li>The <code>dalvik.system.BaseDexClassLoader</code> is yet another internal class that may disappear or change</li>
<li>Even the Dalvik VM will likely go away in the future and be replaced by the new <a href="https://source.android.com/devices/tech/dalvik/art.html">Android ART</a> runtime</li>
</ul>
]]>
   </content:encoded>
  </item>
  <item>
   <title>
    Still Deadlocked
   </title>
   <link/>
   https://www.setera.org/2012/03/11/still-deadlocked/
   <pubdate>
    Sun, 11 Mar 2012 21:19:16 +0000
   </pubdate>
   <dc:creator>
    <![CDATA[Craig Setera]]>
   </dc:creator>
   <category>
    <![CDATA[Android]]>
   </category>
   <category>
    <![CDATA[Clock]]>
   </category>
   <category>
    <![CDATA[Java]]>
   </category>
   <guid ispermalink="false">
    https://www.setera.org/?p=649
   </guid>
   <description>
    <![CDATA[Wow&#8230; three months since my last post about my Android Clock Widget Project. While I&#8217;ve failed to bring stability to the clock selector during that time, I have figured out that the problem is not actually due to a deadlock. Instead, it appears that my project is tickling a bug in the Dalvik VM&#8217;s garbage [&#8230;]]]>
   </description>
   <content:encoded>
    <![CDATA[<p>Wow&#8230; three months since my <a href="https://www.setera.org/2011/12/27/deadlocked/">last post</a> about my <a href="https://www.setera.org/2011/09/04/clock-widget-project/">Android Clock Widget Project</a>.  While I&#8217;ve failed to bring stability to the clock selector during that time, I have figured out that the problem is not actually due to a deadlock.  Instead, it appears that my project is tickling a bug in the Dalvik VM&#8217;s garbage collector.  </p>
<p><span id="more-649"></span><br />
Depending on the device and operating system level, there are subtle changes in behavior.  In most cases, there is a crash log written to the /data/tombstones folder.  The most revealing tombstone file has come from a Samsung Captivate running a version of the <a href="http://forum.aokp.co/">AOKP ICS ROM</a>.</p>
<pre name="code" class="shell">
Build fingerprint: 'samsung/SGH-I897/SGH-I897:2.3.5/GINGERBREAD/UCKK4:user/release-keys'
pid: 1758, tid: 1777  >>> com.seterasoft.mclock <<<
signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr deadbaad
 r0 deadbaad  r1 00000001  r2 40000000  r3 00000000
 r4 00000000  r5 00000027  r6 50c53b40  r7 00000064
 r8 41338018  r9 00000024  10 50c53a6c  fp 50c53ab0
 ip ffffffff  sp 50c53a30  lr 400fdf79  pc 400fa694  cpsr 60000030
 d0  0000000000000000  d1  0000000000000000
 d2  0000000000000000  d3  0000000000000000
 d4  0000000000000000  d5  0000000000000000
 d6  0000000000000000  d7  0000000000000000
 d8  0000000000000000  d9  0000000000000000
 d10 0000000000000000  d11 0000000000000000
 d12 0000000000000000  d13 0000000000000000
 d14 0000000000000000  d15 0000000000000000
 d16 0000000000000000  d17 0000000000000000
 d18 0000000000000000  d19 0000000000000000
 d20 0000000000000000  d21 0000000000000000
 d22 0000000000000000  d23 0000000000000000
 d24 0000000000000000  d25 0000000000000000
 d26 0000000000000000  d27 0000000000000000
 d28 0100010001000100  d29 0100010001000100
 d30 0000000000000000  d31 3ff0000000000000
 scr 2800001b

         #00  pc 00017694  /system/lib/libc.so
         #01  pc 00007bb0  /system/lib/libcutils.so (mspace_merge_objects)
         #02  pc 0007b6c8  /system/lib/libdvm.so (_Z21dvmHeapSourceFreeListjPPv)
         #03  pc 00042ce0  /system/lib/libdvm.so
         #04  pc 00032f94  /system/lib/libdvm.so (_Z22dvmHeapBitmapSweepWalkPK10HeapBitmapS1_jjPFvjPPvS2_ES2_)
         #05  pc 00042c9c  /system/lib/libdvm.so (_Z27dvmHeapSweepUnmarkedObjectsbbPjS_)
         #06  pc 000337c0  /system/lib/libdvm.so (_Z25dvmCollectGarbageInternalPK6GcSpec)
         #07  pc 0005ff6c  /system/lib/libdvm.so (_Z17dvmCollectGarbagev)
         #08  pc 00072a8e  /system/lib/libdvm.so
         #09  pc 00030a8c  /system/lib/libdvm.so
         #10  pc 00034248  /system/lib/libdvm.so (_Z12dvmInterpretP6ThreadPK6MethodP6JValue)
         #11  pc 0006c692  /system/lib/libdvm.so (_Z14dvmCallMethodVP6ThreadPK6MethodP6ObjectbP6JValueSt9__va_list)
         #12  pc 0006c6b4  /system/lib/libdvm.so (_Z13dvmCallMethodP6ThreadPK6MethodP6ObjectP6JValuez)
         #13  pc 0005f7c0  /system/lib/libdvm.so
         #14  pc 00012c14  /system/lib/libc.so (__thread_entry)
         #15  pc 00012744  /system/lib/libc.so (pthread_create)
</pre>
<p>The failing function appears to be implemented in dlmalloc.c in the Android source, but I really don't have any good idea about what might be causing the crash.  I also don't appear to be the only one, as there are <a href="http://groups.google.com/a/googleproductforums.com/forum/#!category-topic/maps/google-maps-for-mobile/XVVmMYYxLUI">other references on the web</a> that look similar.</p>
<p>To this point, I've tried a variety of things to try to track down the problem.  I've gone so far as to try to build my own version of the <a href="http://www.cyanogenmod.com/">Cyanogenmod</a> with the idea that I might be able to add more logging output.  So far, I've not had any luck with this approach.  I generally have no problem walking away from hobby projects when I lose interest.  However, this has turned into a competition of me versus the computer and I'm not quite ready to give up.</p>
]]>
   </content:encoded>
  </item>
  <item>
   <title>
    Inertia
   </title>
   <link/>
   https://www.setera.org/2011/07/30/inertia/
   <comments>
    https://www.setera.org/2011/07/30/inertia/#comments
   </comments>
   <pubdate>
    Sun, 31 Jul 2011 00:23:30 +0000
   </pubdate>
   <dc:creator>
    <![CDATA[Craig Setera]]>
   </dc:creator>
   <category>
    <![CDATA[AndEngine]]>
   </category>
   <category>
    <![CDATA[AndPingus]]>
   </category>
   <category>
    <![CDATA[Android]]>
   </category>
   <category>
    <![CDATA[Java]]>
   </category>
   <category>
    <![CDATA[Mobile]]>
   </category>
   <category>
    <![CDATA[Software Development]]>
   </category>
   <guid ispermalink="false">
    https://www.setera.org/?p=541
   </guid>
   <description>
    <![CDATA[Inertia is the resistance of any physical object to a change in its state of motion or rest, or the tendency of an object to resist any change in its motion. For me, this also describes my tendencies toward side projects like my Pingus project. When I last worked on Pingus a couple of months [&#8230;]]]>
   </description>
   <content:encoded>
    <![CDATA[<blockquote><p>Inertia is the resistance of any physical object to a change in its state of motion or rest, or the tendency of an object to resist any change in its motion.</p></blockquote>
<p>For me, this also describes my tendencies toward side projects like my <a href="https://www.setera.org/2011/06/26/we-are-experiencing-technical-difficulties/">Pingus project</a>.  When I last worked on Pingus a couple of months ago, I updated the underlying <a href="http://andengine.org">AndEngine</a> libraries and found a ton of breaking changes.  I put Pingus on the shelf until I had more time to look at the breakage and how to solve it.  The AndEngine changes are pretty significant and I&#8217;m going to need to rethink portions of Pingus in order to get things running correctly again.  </p>
<p><span id="more-541"></span></p>
<p>Now my personal inertia is kicking in and causing me to put off this rework for a while.  To me, this is the biggest difference between work and hobby projects&#8230; I don&#8217;t <b>have</b> to work on hobby projects if I don&#8217;t want to.  Thus, Pingus is &#8220;on a break&#8221; for a while until I find the energy to bring it up to date relative to the underlying game engine. </p>
<p>In the meantime, I decided I wanted to spend a bit of time taking a look at Android&#8217;s <a href="http://developer.android.com/guide/topics/appwidgets/index.html">App Widget</a> support.  Until I started digging into the documentation and examples, I had always assumed that a widget was provided a Canvas to draw directly on to the home screen.  To me this seemed like it would have been the easiest way for developers to develop widgets.  </p>
<p>It turns out that Android AppWidgets don&#8217;t work that way at all.  AppWidgets are built on top of <a href="http://developer.android.com/reference/android/widget/RemoteViews.html">Remote Views</a>.  According to the Android documentation, Remote Views are</p>
<blockquote><p>A class that describes a view hierarchy that can be displayed in another process. The hierarchy is inflated from a layout resource file, and this class provides some basic operations for modifying the content of the inflated hierarchy.</p></blockquote>
<p>A Remote View is created in one process and passed into the process that owns the Android home screen.  It is actually a <a href="http://developer.android.com/reference/android/os/Parcelable.html">Parcelable</a> object, however due to class loading issues, there is only a very small number of Views and Widgets that are allowed to be passed across the process boundary.  For anything that involves relatively complex graphical rendering, the only real way to drive the widget&#8217;s contents is by specifying a very simple widget layout:</p>
<pre name="code" class="xml">
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
	android:orientation="vertical"
    android:layout_width="fill_parent"
    android:layout_height="fill_parent">
    
    <ImageView
    	android:id="@+id/imageview"
	    android:layout_width="fill_parent" 
	    android:layout_height="wrap_content" 
		android:src="@drawable/icon" />
	    
</LinearLayout>
</pre>
<p>and then sending bitmaps to the image view:</p>
<pre name="code" class="java">
	private void updateWidget(Context context, AppWidgetManager appWidgetManager) {
		Bitmap bitmap = Bitmap.createBitmap(100, 100, Config.ARGB_8888);
		Canvas canvas = new Canvas(bitmap);
		
		this.drawable.draw(canvas);

		RemoteViews views = new RemoteViews(context.getPackageName(), R.layout.main);
		views.setImageViewBitmap(R.id.imageview, bitmap);

		ComponentName componentName = new ComponentName(context, MyAppWidgetProvider.class);
		appWidgetManager.updateAppWidget(componentName, views);
	}
</pre>
<p>While this seems like a high overhead way to handle updates to the widget contents, I have to assume that the Android developers had a good reason for doing things like this.  I can only hope that there are some tricks being done in the Android implementation that lower the cost of this operation.  Given that I&#8217;ve just managed to get this to work at all, I imagine there are is a lot of room for improvement in my use of this API.  However, I found it confusing enough to figure out how to do and thought others might benefit from my pain.</p>
]]>
   </content:encoded>
   <wfw:commentrss>
    https://www.setera.org/2011/07/30/inertia/feed/
   </wfw:commentrss>
   <slash:comments>
    2
   </slash:comments>
  </item>
  <item>
   <title>
    Supporting Extra Large Screens in Android
   </title>
   <link/>
   https://www.setera.org/2011/05/11/supporting-extra-large-screens-in-android/
   <pubdate>
    Thu, 12 May 2011 00:00:20 +0000
   </pubdate>
   <dc:creator>
    <![CDATA[Craig Setera]]>
   </dc:creator>
   <category>
    <![CDATA[AndEngine]]>
   </category>
   <category>
    <![CDATA[AndPingus]]>
   </category>
   <category>
    <![CDATA[Android]]>
   </category>
   <category>
    <![CDATA[Java]]>
   </category>
   <category>
    <![CDATA[Mobile]]>
   </category>
   <category>
    <![CDATA[Software Development]]>
   </category>
   <guid ispermalink="false">
    https://www.setera.org/?p=500
   </guid>
   <description>
    <![CDATA[In my last Android Pingus post I mentioned that I was interested in getting Pingus running full screen on my Motorola Xoom. It was clear from Android Market applications that it was possible to run applications across a wide range of Android versions with full screen support for extra large screens, but it was not [&#8230;]]]>
   </description>
   <content:encoded>
    <![CDATA[<p>In my last <a href="https://www.setera.org/2011/05/07/pingus-on-android-%E2%80%93-%E2%80%9Cdestroyable-terrain%E2%80%9D-3/">Android Pingus post</a> I mentioned that I was interested in getting Pingus running full screen on my Motorola Xoom.  It was clear from Android Market applications that it was possible to run applications across a wide range of Android versions with full screen support for extra large screens, but it was not entirely obvious to me how to actually accomplish that.</p>
<p>In reading the <a href="http://developer.android.com/guide/topics/manifest/supports-screens-element.html">Android <b>supports-screen</b> documentation</a>, it is clear that it is necessary to set the <b>xlargeScreens</b> attribute to <b>true</b>.  However, the <b>xlargeScreens</b> attribute is not supported below API level 9.  Trying to shoehorn that attribute into my project that was attempting to support back to API level 5, resulted in the following error.<br />
<span id="more-500"></span></p>
<div id="attachment_504" style="width: 938px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2011/05/xlargescreensfail.png"><img src="https://www.setera.org/wp-content/uploads/2011/05/xlargescreensfail.png" alt="" title="XLargeScreens Fail" width="928" height="415" class="size-full wp-image-504" srcset="https://www.setera.org/wp-content/uploads/2011/05/xlargescreensfail.png 928w, https://www.setera.org/wp-content/uploads/2011/05/xlargescreensfail-300x134.png 300w" sizes="(max-width: 928px) 100vw, 928px" /></a><p class="wp-caption-text">XLargeScreens Attribute Failure</p></div>
<p>With a bit of finagling, I was able to get things working.  In order to allow the <b>xlargeScreens</b> attribute, it is necessary to specify a target SDK version of at least 9.</p>
<div id="attachment_507" style="width: 729px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2011/05/xlargescreensworking.png"><img src="https://www.setera.org/wp-content/uploads/2011/05/xlargescreensworking.png" alt="" title="XLargeScreens Working" width="719" height="462" class="size-full wp-image-507" srcset="https://www.setera.org/wp-content/uploads/2011/05/xlargescreensworking.png 719w, https://www.setera.org/wp-content/uploads/2011/05/xlargescreensworking-300x192.png 300w" sizes="(max-width: 719px) 100vw, 719px" /></a><p class="wp-caption-text">XLargeScreens Working</p></div>
<p>This screenshot shows how the minimum SDK version can be set below version 9 and the target version is set to 9, allowing the <b>xlargeScreens</b> attribute to be specified.  In addition, it is necessary to change the Android version level in the project properties.</p>
<div id="attachment_509" style="width: 638px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2011/05/xlargescreensprops.png"><img src="https://www.setera.org/wp-content/uploads/2011/05/xlargescreensprops.png" alt="" title="XLargeScreens Properties" width="628" height="518" class="size-full wp-image-509" srcset="https://www.setera.org/wp-content/uploads/2011/05/xlargescreensprops.png 628w, https://www.setera.org/wp-content/uploads/2011/05/xlargescreensprops-300x247.png 300w" sizes="(max-width: 628px) 100vw, 628px" /></a><p class="wp-caption-text">XLargeScreens Properties</p></div>
<p>With the project properties set to use API level 9 there does not appear to be any automated way to restrict access to API that was older than version 9.  Because of this, I do worry about choosing Android API&#8217;s that will not work at the <i>minimum</i> SDK and will fail on-device.  My plan at this point is to switch back to building primarily for low end and switch once in a while to try on my Xoom.  If I were a bit more serious, I would probably handle this automatically as part of a build script.</p>
<p>I do wish that Google had handled things differently in regard to how this works.</p>
]]>
   </content:encoded>
  </item>
  <item>
   <title>
    Pingus on Android – “Destroyable Terrain” #3
   </title>
   <link/>
   https://www.setera.org/2011/05/07/pingus-on-android-%e2%80%93-%e2%80%9cdestroyable-terrain%e2%80%9d-3/
   <comments>
    https://www.setera.org/2011/05/07/pingus-on-android-%e2%80%93-%e2%80%9cdestroyable-terrain%e2%80%9d-3/#comments
   </comments>
   <pubdate>
    Sun, 08 May 2011 01:39:42 +0000
   </pubdate>
   <dc:creator>
    <![CDATA[Craig Setera]]>
   </dc:creator>
   <category>
    <![CDATA[AndEngine]]>
   </category>
   <category>
    <![CDATA[AndPingus]]>
   </category>
   <category>
    <![CDATA[Android]]>
   </category>
   <category>
    <![CDATA[Mobile]]>
   </category>
   <category>
    <![CDATA[Software Development]]>
   </category>
   <guid ispermalink="false">
    https://www.setera.org/?p=479
   </guid>
   <description>
    <![CDATA[Despite traveling soccer season heating up, I have managed to make some real progress on destroyable terrain since hitting a wall in my last post. Ground tiles are now implemented and working quite well. In this first video, you can see the individual tiles being marked as the digger works its way through the ground. [&#8230;]]]>
   </description>
   <content:encoded>
    <![CDATA[<p>Despite traveling soccer season heating up, I have managed to make some real progress on destroyable terrain <a href="https://www.setera.org/2011/03/27/pingus-on-android-%e2%80%93-%e2%80%9cdestroyable-terrain%e2%80%9d-2/">since hitting a wall in my last post.</a>  Ground tiles are now implemented and working quite well.  In this first video, you can see the individual tiles being marked as the digger works its way through the ground.</p>
<p><object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/TKe2g-Nx9o0?hl=en&#038;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/TKe2g-Nx9o0?hl=en&#038;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>
<p><span id="more-479"></span></p>
<p>Once it was clear that the correct tiles were being found and that the image alteration was working, the next step was to calculate the correct alterations to match the digger&#8217;s location as shown as red in this video.</p>
<p><object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/IQkni8UgUzU?hl=en&#038;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/IQkni8UgUzU?hl=en&#038;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>
<p>Finally, terrain destruction was completed by clearing those same image pixels to transparent resulting in the following.</p>
<p><object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/Z-KKPJWGKaU?hl=en&#038;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/Z-KKPJWGKaU?hl=en&#038;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>
<h2>Clearing to Transparent</h2>
<p>Clearing the image pixels to transparent turned out to be a bit trickier than I had guessed it would be.  The default paint <a href="http://developer.android.com/reference/android/graphics/Paint.html#setXfermode(android.graphics.Xfermode)">&#8220;transfer mode&#8221;</a> is such that painting with a transparent color results in no changes to the image.  In order to erase the image to transparency, the transfer mode needs to be changed like the following:</p>
<pre name="code" class="java">
		// Set up a paint that can be used to clear pixels from a ground tile
		Paint paint = new Paint();
		paint.setColor(Color.TRANSPARENT);
		paint.setXfermode(new PorterDuffXfermode(PorterDuff.Mode.CLEAR));
		paint.setStrokeWidth(1);
</pre>
<p>With the paint set to CLEAR mode, the Android graphics functions can then be used to alter the image pixels.</p>
<h2>New Things Uncovered</h2>
<p>I recently picked up a Motorola Xoom that I have also thrown AndPingus on to.  It showed me that there are a couple of pretty interesting issues with the current implementation:</p>
<ul>
<li>Proper Speed Scaling<br />The digger handler doesn&#8217;t properly account for clock speed and digging happens way too fast on something as fast as the Xoom.</li>
<li>Extra Large Screens<br />Recent Android versions introduced extra large screen support.  Unfortunately, AndPingus isn&#8217;t correctly utilizing the screen size yet.  I&#8217;m still trying to understand how to properly handle older devices at the same time as the extra large screen size.</li>
</ul>
<h2>Planned Source Release</h2>
<p>I&#8217;ve decided that I&#8217;m going to go ahead and release a couple of utility pieces of the AndPingus source code as open source for others to take advantage of.  My plan is to make available the following pieces:</p>
<ul>
<li>QuadTree<br />I created a QuadTree implementation for searching the sprites.  At the moment, because of the ground tiles, that code is not being used.  However, it seems like it may useful to others.</li>
<li>Drawable Texture Support<br />This is the underlying implementation of the destroyable terrain implementation in AndPingus.</li>
</ul>
<p>As I mentioned before, I&#8217;m getting busy with soccer coaching these days, so I can&#8217;t offer a specific timeframe for the release.  Before I can make that happen, I need to decide on appropriate licensing and hosting options.  In addition, I need to do at least a bit of cleanup before unleashing it to others.  Stay tuned to this blog for more information when it becomes available.</p>
]]>
   </content:encoded>
   <wfw:commentrss>
    https://www.setera.org/2011/05/07/pingus-on-android-%e2%80%93-%e2%80%9cdestroyable-terrain%e2%80%9d-3/feed/
   </wfw:commentrss>
   <slash:comments>
    2
   </slash:comments>
  </item>
  <item>
   <title>
    Rockbox Tagcache Database Generator
   </title>
   <link/>
   https://www.setera.org/2011/04/12/rockbox-tagcache-database-generator/
   <pubdate>
    Tue, 12 Apr 2011 10:51:37 +0000
   </pubdate>
   <dc:creator>
    <![CDATA[Craig Setera]]>
   </dc:creator>
   <category>
    <![CDATA[Rockbox]]>
   </category>
   <category>
    <![CDATA[Software Development]]>
   </category>
   <guid ispermalink="false">
    https://www.setera.org/?p=461
   </guid>
   <description>
    <![CDATA[I&#8217;m cheap. I like geek toys, but tend to go cheap whenever possible. I still like my cheap Sandisk Fuze (V2) for working out, particularly with the Rockbox player loaded. Recently, I changed up the music on the device and the music database functionality in Rockbox started hanging while building the database. While still usable, [&#8230;]]]>
   </description>
   <content:encoded>
    <![CDATA[<p>I&#8217;m cheap.  I like geek toys, but tend to go cheap whenever possible.  I still like my cheap Sandisk Fuze (V2) for working out, particularly with the <a href="http://www.rockbox.org/">Rockbox</a> player loaded.  Recently, I changed up the music on the device and the music database functionality in Rockbox started hanging while building the database.  While still usable, the player just isn&#8217;t quite as good without the database functionality.</p>
<p>When I <a href="https://www.setera.org/2011/03/27/pingus-on-android-%E2%80%93-%E2%80%9Cdestroyable-terrain%E2%80%9D-2/">hit the wall with Android Pingus</a> I decided to tackle a Rockbox database generator, based on the <a href="http://www.rockbox.org/wiki/TagcacheDBFormat">documentation in the Rockbox wiki</a>.  Using that documentation along with looking at the Rockbox source code and lots of binary comparisons, I managed to get a Java-based tool built for generating a Rockbox database on the PC that can be loaded onto my Fuze.  I&#8217;ve released the first release of the <a href="https://www.setera.org/projects/rockbox-tagcache-database-generator/">Rockbox Tagcache Database Generator</a>.  This not necessarily a tool for the feint of heart, as it is a command-line tool driven by a configuration file.  With that said, I do think it is pretty easy to use for its purpose and I&#8217;m happily using the results from the tool every day when I go to the gym.</p>
<p>As with many of my projects, this tool comes with zero warranty or support.  &#8220;It works for me&#8221; is the best I can say for this tool at this point.  The source is available on the page as well for those that may want to tinker or offer patches.  At the moment, I have no need or interest in adding new features to this tool, since it is getting the job done for me.  With that said, patches to the source would be something I would consider creating a new version to track.</p>
]]>
   </content:encoded>
  </item>
  <item>
   <title>
    Pingus on Android – “Destroyable Terrain” #2
   </title>
   <link/>
   https://www.setera.org/2011/03/27/pingus-on-android-%e2%80%93-%e2%80%9cdestroyable-terrain%e2%80%9d-2/
   <pubdate>
    Sun, 27 Mar 2011 21:32:08 +0000
   </pubdate>
   <dc:creator>
    <![CDATA[Craig Setera]]>
   </dc:creator>
   <category>
    <![CDATA[AndEngine]]>
   </category>
   <category>
    <![CDATA[AndPingus]]>
   </category>
   <category>
    <![CDATA[Android]]>
   </category>
   <category>
    <![CDATA[Java]]>
   </category>
   <category>
    <![CDATA[Mobile]]>
   </category>
   <category>
    <![CDATA[Software Development]]>
   </category>
   <guid ispermalink="false">
    https://www.setera.org/?p=431
   </guid>
   <description>
    <![CDATA[When we last met I had begun working on the ability for the Pingus character to destroy the terrain. At that point, I had managed to get the images updated for the sprites that made up the image, but since those images were shared all of the sprites that shared the image were being affected. [&#8230;]]]>
   </description>
   <content:encoded>
    <![CDATA[<p>When we <a href="../../../../2011/03/05/pingus-on-android-destroyable-terrain-1">last met</a> I had begun working on the ability for the Pingus character to destroy the terrain.  At that point, I had managed to get the images updated for the sprites that made up the image, but since those images were shared all of the sprites that shared the image were being affected.<br />
<span id="more-431"></span></p>
<p>I added support to separate the sprite images when a sprite needed to be altered, but it took me a while to realize I was forgetting to set the correct position for the newly created sprite.  This resulted in this confusing result.</p>
<p><object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/cQTSG325xMo?hl=en&#038;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/cQTSG325xMo?hl=en&#038;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>
<p>Once I realized that the issue was due to incorrect image/sprite generation, I had a much better result.</p>
<p><object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/B_IeC-LCdDo?hl=en&#038;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/B_IeC-LCdDo?hl=en&#038;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>
<p>It became clear very quickly that my current approach for ground sprites was not going to work very well.  Using the same images scaled and rotated in various ways makes it very difficult to find the correct sprite and, as you can see from the red X&#8217;s, it also means that many sprite images may need to be altered in the course of digging out a particular chunk of terrain.</p>
<h2>Ground Tiles</h2>
<p>To improve this such that the sprites would be more aligned and easier to deal with, I&#8217;m switching to using pre-generated ground tiles.  The tooling that currently generates the collision map has been extended to generate a set of square ground tiles.  Starting with an image that contains all of the ground sprites:</p>
<div id="attachment_436" style="width: 310px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2011/03/ground1.png"><img src="https://www.setera.org/wp-content/uploads/2011/03/ground1-300x150.png" alt="" title="Full Ground Image" width="300" height="150" class="size-medium wp-image-436" srcset="https://www.setera.org/wp-content/uploads/2011/03/ground1-300x150.png 300w, https://www.setera.org/wp-content/uploads/2011/03/ground1-1024x512.png 1024w, https://www.setera.org/wp-content/uploads/2011/03/ground1.png 1400w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Full Ground Image</p></div>
<p>This image can be cropped down to include only the non-transparent area:</p>
<div id="attachment_437" style="width: 310px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2011/03/ground2.png"><img src="https://www.setera.org/wp-content/uploads/2011/03/ground2-300x118.png" alt="" title="Cropped Ground Image" width="300" height="118" class="size-medium wp-image-437" srcset="https://www.setera.org/wp-content/uploads/2011/03/ground2-300x118.png 300w, https://www.setera.org/wp-content/uploads/2011/03/ground2-1024x403.png 1024w, https://www.setera.org/wp-content/uploads/2011/03/ground2.png 1116w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Cropped Ground Image</p></div>
<p>Finally, it is broken down into individual tiles:</p>
<div id="attachment_438" style="width: 310px" class="wp-caption aligncenter"><a href="https://www.setera.org/wp-content/uploads/2011/03/ground3.png"><img src="https://www.setera.org/wp-content/uploads/2011/03/ground3-300x118.png" alt="" title="Ground Tiles" width="300" height="118" class="size-medium wp-image-438" srcset="https://www.setera.org/wp-content/uploads/2011/03/ground3-300x118.png 300w, https://www.setera.org/wp-content/uploads/2011/03/ground3-1024x403.png 1024w, https://www.setera.org/wp-content/uploads/2011/03/ground3.png 1116w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Ground Tiles</p></div>
<p>Each non-transparent tile is stored individually.  A new ground tile map object tracks the images and transparent tiles.  At the moment, the tiles are being generated as 128&#215;128 pixel images, which plays well with the OpenGL requirement that textures must be sized as a power of 2.  Dependent on the maximum texture size, multiple ground tiles may be laid out within the texture with a minimum wasted space.  The trick will be to pick an appropriate size to balance the various costs involved in loading and manipulating the sprite textures when destruction occurs.</p>
<p>While I had hoped to actually show this work via video in this post, I&#8217;ve run up against a bit of a roadblock.  While fixing one problem, I&#8217;ve introduced another issue that I can&#8217;t seem to resolve.  At this point it is better for me to walk away from this project for a few days and come back with a fresh set of eyes.  With any hope, my next entry will show a final working destroyable terrain implementation.</p>
]]>
   </content:encoded>
  </item>
  <item>
   <title>
    Pingus on Android – “Destroyable Terrain” #1
   </title>
   <link/>
   https://www.setera.org/2011/03/05/pingus-on-android-destroyable-terrain-1/
   <pubdate>
    Sun, 06 Mar 2011 00:58:10 +0000
   </pubdate>
   <dc:creator>
    <![CDATA[Craig Setera]]>
   </dc:creator>
   <category>
    <![CDATA[AndEngine]]>
   </category>
   <category>
    <![CDATA[AndPingus]]>
   </category>
   <category>
    <![CDATA[Android]]>
   </category>
   <category>
    <![CDATA[Java]]>
   </category>
   <guid ispermalink="false">
    https://www.setera.org/?p=409
   </guid>
   <description>
    <![CDATA[They say that slow and steady wins the race. In the case of this project, the only thing I have going for me is the slow part. Nicolas Gramlich, author of the AndEngine library on which this is based, referred to this part of the project as &#8220;destroyable terrain&#8221;. I really like that phrase, so [&#8230;]]]>
   </description>
   <content:encoded>
    <![CDATA[<p>They say that slow and steady wins the race.  In the case of this project, the only thing I have going for me is the slow part.  Nicolas Gramlich, author of the <a href="http://www.andengine.org/">AndEngine library</a> on which this is based, referred to this part of the project as &#8220;destroyable terrain&#8221;.  I really like that phrase, so I think I will continue to use it here.</p>
<p>In <a href="https://www.setera.org/2011/02/19/pingus-on-android-early-digger-support/">Early Digger Support</a> I covered the initial digger support.  At that point I had managed to update the <a href="https://www.setera.org/2011/01/16/pingus-on-android-more-collision-detection/">in-memory collision map</a>, but updating the actual textures driving AndEngine was proving to be a bit more difficult.  I&#8217;m still not there, but I think I&#8217;m moving in a positive direction.  The following video shows the current state of things.  The textures are being updated with a full red fill to make it clear that they have been hit.</p>
<p><object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/-8GmL4jHq_I?hl=en&#038;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/-8GmL4jHq_I?hl=en&#038;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>
<p>So, why is everything turning red?   Well, that turns out to be the next item that will need to be dealt with&#8230; shared textures.  To save memory, many of the sprites share common textures and texture regions.  Thus, in the current implementation, changing the underlying texture information affects all sprites that share that information.  This is something I knew would have to be dealt with eventually, so it appears that eventually is <em>now</em>.</p>
<p><span id="more-409"></span></p>
<h2>Quad Trees</h2>
<p>When I initially started playing with altering the texture data, I was worried about performance.  My first attempt to locate the sprites to be altered used the standard AndEngine functionality to query collisions using the &#8220;collidesWith&#8221; method for shapes.  This proved to be really expensive for gross-level collision detection.  My performance tests using the built in Android tools for capturing trace data showed that much of the cost of the terrain destruction was accountable to simply finding the sprite to be altered.</p>
<p>I had heard previously about the use of <a href="http://en.wikipedia.org/wiki/Octree">Octrees</a> in 3D to help do quick searches on the boundaries of objects.  In the 2D world, <a href="http://en.wikipedia.org/wiki/Quadtree">Quadtrees</a> are used instead.  I was surprised not to find an actual Quadtree implementation on the web, but was able to piece together a nice generic implementation based on lots of research.  With the Quadtree, I was able to get closer to reasonable performance, as you can see in the video capture.  My hope is that using a Quadtree and doing the necessary cloning to split sprite textures will lead to a reasonably performant destroyable terrain implementation, but that is still yet to be seen.</p>
<h2>Java Generics Aside</h2>
<p>My Quadtree implementation initially was built to accept a single object type.  It seemed more useful to use Java Generics to make the Quadtree more generally useful.  I was hung up by one thing though.  I wanted to be able to allow the Quadtree to accept objects with a certain interface declaration.  Basically, I wanted this:</p>
<pre name="code" class="java">
public class Quadtree&lt;T implements IBoundedObject&gt; {
</pre>
<p>Where IBoundedObject is simply defined as:</p>
<pre name="code" class="java">
public interface IBoundedObject {
	Rect getBounds();
}
</pre>
<p>However, the <em><code>implements</code></em> extension is not supported by the generics syntax.  This had me confused for a while until I realized that it is possible to do what I wanted to do, but needed to specify <em><code>extends</code></em>:</p>
<pre name="code" class="java">
public class Quadtree&lt;T extends IBoundedObject&gt; {
</pre>
<p>I&#8217;m sure there is some perfectly good technical reason for doing things this way, but personally I find the lack of consistency confusing and unnecessary.</p>
<h2>Next Time</h2>
<p>With any luck, I will be able to show a reasonably performant implementation of destroyable terrain by pulling the various pieces together.</p>
]]>
   </content:encoded>
  </item>
  <item>
   <title>
    Pingus on Android – Early Digger Support
   </title>
   <link/>
   https://www.setera.org/2011/02/19/pingus-on-android-early-digger-support/
   <pubdate>
    Sat, 19 Feb 2011 20:28:42 +0000
   </pubdate>
   <dc:creator>
    <![CDATA[Craig Setera]]>
   </dc:creator>
   <category>
    <![CDATA[AndEngine]]>
   </category>
   <category>
    <![CDATA[AndPingus]]>
   </category>
   <category>
    <![CDATA[Android]]>
   </category>
   <category>
    <![CDATA[Java]]>
   </category>
   <category>
    <![CDATA[Mobile]]>
   </category>
   <category>
    <![CDATA[Software Development]]>
   </category>
   <guid ispermalink="false">
    https://www.setera.org/?p=401
   </guid>
   <description>
    <![CDATA[Work and life have conspired to keep me from making a lot of progress on my Android on Pingus project. I had hoped to get further before posting here again, but instead decided to go ahead and post a minor update. In my last post I covered my early collision detection implementation. The next step [&#8230;]]]>
   </description>
   <content:encoded>
    <![CDATA[<p>Work and life have conspired to keep me from making a lot of progress on my Android on Pingus project.  I had hoped to get further before posting here again, but instead decided to go ahead and post a minor update.  In my <a href="https://www.setera.org/2011/01/16/pingus-on-android-more-collision-detection/">last post</a> I covered my early collision detection implementation.</p>
<p>The next step was to start implementing some behaviors for the Pingus.  The <em>digger</em> behavior seemed a good place to start.  In order to implement the digger, it is necessary to actually alter the collision map generated by the tool.  In the end, this part was pretty easy to handle.  The results are captured in the video capture.</p>
<p><object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/JXHjl-FJ5us?hl=en&#038;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/JXHjl-FJ5us?hl=en&#038;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>
<p>While it was relatively easy to carve out a path through the in-memory collision map, updating the actual graphics is proving to be much more difficult.  AndEngine implements 2D graphics using 3D/OpenGL.  This implies that in order to update the graphics, the underlying texture images need to be updated.  I&#8217;m in the process of building AndEngine support for altering the underlying texture images.  At the moment, this appears to be slow and may need to be abandoned.  Just like while I worked on the collision map, the lack of guarantee for clipping and Z buffer on Android devices further complicate the situation.</p>
<p>While there are times that I wonder if using AndEngine for this project is makes it more difficult, I&#8217;m not quite ready to give it up.  More to come&#8230;</p>
]]>
   </content:encoded>
  </item>
  <item>
   <title>
    Pingus on Android – More Collision Detection
   </title>
   <link/>
   https://www.setera.org/2011/01/16/pingus-on-android-more-collision-detection/
   <comments>
    https://www.setera.org/2011/01/16/pingus-on-android-more-collision-detection/#comments
   </comments>
   <pubdate>
    Sun, 16 Jan 2011 14:55:19 +0000
   </pubdate>
   <dc:creator>
    <![CDATA[Craig Setera]]>
   </dc:creator>
   <category>
    <![CDATA[AndEngine]]>
   </category>
   <category>
    <![CDATA[AndPingus]]>
   </category>
   <category>
    <![CDATA[Android]]>
   </category>
   <category>
    <![CDATA[Java]]>
   </category>
   <category>
    <![CDATA[Software Development]]>
   </category>
   <guid ispermalink="false">
    https://www.setera.org/?p=342
   </guid>
   <description>
    <![CDATA[It is a good thing that I&#8217;m not trying to make my living with this little project, given the slow forward progress. However, there is continued progress on the collision detection compared to my last update Pingus On Android – Early Collision Detection. As you can see from this video, things are still a bit [&#8230;]]]>
   </description>
   <content:encoded>
    <![CDATA[<p>It is a good thing that I&#8217;m not trying to make my living with this little project, given the slow forward progress.  However, there is continued progress on the collision detection compared to my last update <a href="https://www.setera.org/2011/01/01/pingus-on-android-early-collision-detection/">Pingus On Android – Early Collision Detection</a>.</p>
<p><object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/dlEt6vNsc3A?hl=en&#038;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/dlEt6vNsc3A?hl=en&#038;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>
<p><span id="more-342"></span></p>
<p>As you can see from this video, things are still a bit twitchy, but at least Pingus is able to step up and down.  To get to this point, I considered a couple of options for improving the collision detection in the system.</p>
<ul>
<li>Use the OpenGL stencil buffer<br />While this might be an interesting approach, the stencil buffer is not guaranteed to be available on all devices.</li>
<li>glReadPixels at collision point<br />Using glReadPixels &#8220;around&#8221; the point of a potential collision might be possible, but appeared to be a fairly expensive operation.  In addition, it would be difficult to determine whether a pixel was &#8220;ground or &#8220;solid&#8221;.</li>
<li>glReadPixels to build a full collision map during startup<br />This approach would be an improvement over continually using glReadPixels, by caching the results, but suffers from many of the same problems.  In addition, the cached image would be large if 4-byte pixels were used.</li>
</ul>
<h2>Pre-generated Collision Map</h2>
<p>In the end, I decided that the best approach was to use an external tool to generate a collision map.  Unlike many other games, the Pingus world is fairly static, allowing the pre-generation of the map.  It is clear that some future aspects of the gameplay will require more dynamic collision detection, but pre-generating this much of the collision map offered a lot of positives:</p>
<ul>
<li>Allowed the hard work of calculating the collision map to be moved outside of the constrained mobile environment.</li>
<li>Allowed the collision map output and associated object wrapper to be tested outside of the constrained mobile environment.</li>
<li>Allowed the collision map data to be heavily processed to provide the smallest usable map.</li>
</ul>
<h3>Initial Map Image</h3>
<p>The first step in the generation of the collision map is to create an image representing the world objects.  This initial image is generated using the Java image API&#8217;s in the RGB colorspace using the full color sprite images.  Between the bit-depth and the excess transparent space in the image, this image is much larger than needed for the collision map.  The following image (scaled down), demonstrates the wasted space.</p>
<p style="text-align: center;"><a href="https://www.setera.org/wp-content/uploads/2011/01/rgb-full-cmap.png"><img class="aligncenter size-full wp-image-343" title="Full Level RGB Collision Map" src="https://www.setera.org/wp-content/uploads/2011/01/rgb-full-cmap.png" alt="" width="490" height="245" srcset="https://www.setera.org/wp-content/uploads/2011/01/rgb-full-cmap.png 700w, https://www.setera.org/wp-content/uploads/2011/01/rgb-full-cmap-300x150.png 300w" sizes="(max-width: 490px) 100vw, 490px" /></a></p>
<h3>Indexed Image</h3>
<p>In an attempt to reduce the size of the individual pixels, the image was converted to a indexed color model.  However, the Java image API&#8217;s will always attempt to match the closest color, yielding a collision map that looks like the following.  Just not quite what we need.</p>
<p><a href="https://www.setera.org/wp-content/uploads/2011/01/indexed1-full-cmap.png"><img class="aligncenter size-full wp-image-346" title="First Indexed Image Collision Map" src="https://www.setera.org/wp-content/uploads/2011/01/indexed1-full-cmap.png" alt="" width="560" height="280" srcset="https://www.setera.org/wp-content/uploads/2011/01/indexed1-full-cmap.png 700w, https://www.setera.org/wp-content/uploads/2011/01/indexed1-full-cmap-300x150.png 300w" sizes="(max-width: 560px) 100vw, 560px" /></a></p>
<h3>Indexed Image Corrected</h3>
<p>Instead of drawing the sprite images directly into the indexed collision map, it is necessary to first convert the sprite images, marking opaque versus transparent images before drawing the collision map.  In the following image, the colors have been mapped to mean:</p>
<ul>
<li>cyan &#8211; Transparent</li>
<li>blue &#8211; Liquid</li>
<li>green &#8211; Ground</li>
<li>red &#8211; Solid (not shown)</li>
</ul>
<p>The original PNG that this scaled version originated from is 1400&#215;700 pixels and is 3.5K on disk (with compression, etc).  Uncompressed, it is a fairly large image to deal with in memory.</p>
<p><a href="https://www.setera.org/wp-content/uploads/2011/01/indexed2-full-cmap.png"><img src="https://www.setera.org/wp-content/uploads/2011/01/indexed2-full-cmap.png" alt="" title="Full size indexed collision map" width="700" height="350" class="aligncenter size-full wp-image-349" srcset="https://www.setera.org/wp-content/uploads/2011/01/indexed2-full-cmap.png 700w, https://www.setera.org/wp-content/uploads/2011/01/indexed2-full-cmap-300x150.png 300w" sizes="(max-width: 700px) 100vw, 700px" /></a></p>
<p>It turns out that dealing with alpha values in the Java image library is somewhat tricky.  The way alpha is dealt with depends on the underlying color model that is being used.  To avoid having to always check during the conversion of the RGB sprite images into the opaque/transparent image, the following class helped.</p>
<pre name="code" class="java">
	class ColorMapTransparencyHelper {
		private ColorModel colorModel;
		private boolean hasTranparentPixel;
		private int transparentPixelRGB;
		
		ColorMapTransparencyHelper(ColorModel colorModel) {
			this.colorModel = colorModel;
			
			if (colorModel instanceof IndexColorModel) {
				IndexColorModel indexColorModel = (IndexColorModel) colorModel;
				
				int transparentPixel = indexColorModel.getTransparentPixel();
				if (transparentPixel != -1) {
					hasTranparentPixel = true;
					transparentPixelRGB = indexColorModel.getRGB(transparentPixel);
				}
			}
		}
		
		boolean hasAlpha(int rgb) {
			return hasTranparentPixel ? 
				(rgb == transparentPixelRGB) : 
				(colorModel.getAlpha(rgb) != 0);
		}
	}
</pre>
<h3>Crop and Corrected Indexed Image</h3>
<p>The final step was to eliminate as much transparency as possible.  The following cropped image is the final image result.  The PNG image in this case is 1400&#215;440 pixels and compressed to 3.1K.</p>
<p><a href="https://www.setera.org/wp-content/uploads/2011/01/indexed2-crop-cmap.png"><img src="https://www.setera.org/wp-content/uploads/2011/01/indexed2-crop-cmap.png" alt="" title="Cropped Collision Map" width="700" height="220" class="aligncenter size-full wp-image-356" srcset="https://www.setera.org/wp-content/uploads/2011/01/indexed2-crop-cmap.png 700w, https://www.setera.org/wp-content/uploads/2011/01/indexed2-crop-cmap-300x94.png 300w" sizes="(max-width: 700px) 100vw, 700px" /></a></p>
<h2>Moving Beyond the Image</h2>
<p>Originally, I had thought I would use a packaged PNG image as the basis for the collision map on the device.  While this might have worked out, the biggest problem was that the Android graphics API does not make it easy to get the <strong><em>index</em></strong> of the pixel rather than the RGB value.  The multiple conversions required to deal with the image as a collision map ended up being more heavyweight than it seemed worthwhile.  Thus, the final step the tool takes is to convert the PNG image into an array of bytes representing the states of the pixels.  These bytes are written to the package and read by the device as the collision map.  </p>
<p>The model class that wraps this data is aware of the transparent regions that are not part of the collision map values and those are automatically taken care of by the model class.  This yields a very simple API for callers:</p>
<pre name="code" class="java">
public class CollisionMap {
	public static byte PIXEL_TRANSPARENT = 0;
	public static byte PIXEL_SOLID = 1;
	public static byte PIXEL_GROUND = 2;
	public static byte PIXEL_WATER = 3;

	/**
	 * Get the collision value at the specified location.
	 * 
	 * @param x
	 * @param y
	 * @return
	 */
	public byte getCollisionValue(int x, int y);

	/**
	 * Get an array of bytes representing the map values for the specified
	 * column.
	 * 
	 * @param x_start
	 * @param y
	 * @param width
	 * @return
	 */
	public byte[] getHorizontalCollisionEdge(int x_start, int y, int width);

	/**
	 * Get an array of bytes representing the map values for the specified row.
	 * 
	 * @param x
	 * @param y_start
	 * @param height
	 * @return
	 */
	public byte[] getVerticalCollisionEdge(int x, int y_start, int height);

	/**
	 * Set the specified collision map value.
	 * 
	 * @param x
	 * @param y
	 * @param value
	 */
	public void setCollisionValue(int x, int y, byte value);
}
</pre>
<p>With the collision map in place, it is then possible to query for information about the world around the Pingus.  This information will be further useful in implementing things like the visual world map and determining whether a Pingus can dig at a particular location.  </p>
<p>To be continued&#8230;</p>
]]>
   </content:encoded>
   <wfw:commentrss>
    https://www.setera.org/2011/01/16/pingus-on-android-more-collision-detection/feed/
   </wfw:commentrss>
   <slash:comments>
    2
   </slash:comments>
  </item>
 </channel>
</rss>
